
/*******************************************************************************
 * Copyright (c) 2010, Romain Ruetschi <romain.ruetschi@gmail.com>
 * Distributed under the Boost Software License, Version 1.0.
 * 
 * Boost Software License - Version 1.0 - August 17th, 2003
 * 
 * Permission is hereby granted, free of charge, to any person or organization
 * obtaining a copy of the software and accompanying documentation covered by
 * this license (the "Software") to use, reproduce, display, distribute,
 * execute, and transmit the Software, and to prepare derivative works of the
 * Software, and to permit third-parties to whom the Software is furnished to
 * do so, all subject to the following:
 * 
 * The copyright notices in the Software and this entire statement, including
 * the above license grant, this restriction and the following disclaimer,
 * must be included in all copies of the Software, in whole or in part, and
 * all derivative works of the Software, unless such copies or derivative
 * works are solely in the form of machine-executable object code generated by
 * a source language processor.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
 * SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
 * FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
 * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 ******************************************************************************/

/*!
 * @file        askull.c
 * @copyright   2010, Romain Ruetschi <romain.ruetschi@gmail.com>
 * @abstract    ASKULL main file.
 */

/* System includes */
#include <stdlib.h>
#include <stdio.h>

/* Enable/disable ASKULL debugging */
#define ASKULL_ENABLE_DEBUG 1

/* ASKULL includes */
#include "askull.h"

int main( int argc, char * argv[] )
{                        
    long                          count       = 0;
    long                          size        = 0;
    char                          current     = 0;
    char                          last        = -1;
    FILE                        * file        = NULL;
    
    if( argc < 2 )
    {
        ASKULL_USAGE( argv[ 0 ] );
    }
    
    file = fopen( argv[ 1 ], "rt" );
    
    if( file == NULL )
    {
        ASKULL_ERROR( "File '%s' cannot be opened.", argv[ 1 ] );
    }
    
    fseek( file, 0 , SEEK_END );
    size = ftell( file );
    rewind( file );
    flockfile( file );
    
    printf( "\n" ASKULL_VERSION, size + 5 );
    printf( "\n" ASKULL_HEADER() );
    
    do
    {
        current = getc_unlocked( file );
        
        if( ferror_unlocked( file ) )
        {
            ASKULL_ERROR( "An error occured during reading the file.", NULL );
        }
        
        if( current != last || feof( file ) )
        {
            if( last != -1 )
            {
                askull_print_skl_char( last, count );
            }
            else if( current == EOF )
            {
                break;
            }
            
            last  = current;
            count = 1;
        }
        else
        {
            count++;
        }
    }
    while( 1 );
    
    printf( ASKULL_FOOTER() "\n\n" );
    
    funlockfile( file );
    fclose( file );
    
    return EXIT_SUCCESS;
}

/*!
 * @function    askull_print_skl
 * @abstract    Print a single `character` `count` times in SKL.
 * @param       char    character   The character to print.
 * @param       long    count       The number of times to repeat it.
 */
void askull_print_skl_char( char character, long count )
{
    static char skl[ 20 ];
    
    switch( character )
    {
        case ' ':
            sprintf( skl, ASKULL_EOS_SKL_READ );
        break;
        
        case '#':
            sprintf( skl, ASKULL_EOS_SKL_WRITE );
        break;
        
        case '\n':
            sprintf( skl, ASKULL_EOS_SKL_SBRK );
        break;
        
        default:
            sprintf( skl, "0%o", character );
    }
    
    while( count-- )
    {
        printf( "    " ASKULL_EOS_SKL_LP ", \\\n", skl );
    }
}